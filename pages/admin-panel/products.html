// Dans products.html, remplacez toute la partie <script> par :

<script src="auth.js"></script>
<script src="admin.js"></script>
<script src="products.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gestion de la déconnexion
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            auth.logout();
        });

        // Variables pour la pagination
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredProducts = [];

        // Afficher tous les produits
        async function displayProducts() {
            try {
                // Charger les produits depuis le gestionnaire
                const allProducts = productManager.getAllProducts();
                
                // Vérifier que allProducts est un tableau
                if (!Array.isArray(allProducts)) {
                    console.error('❌ allProducts is not an array:', allProducts);
                    allProducts = [];
                }
                
                // Appliquer les filtres
                filteredProducts = allProducts.filter(product => {
                    const categoryFilter = document.getElementById('categoryFilter')?.value;
                    const statusFilter = document.getElementById('statusFilter')?.value;
                    const stockFilter = document.getElementById('stockFilter')?.value;
                    
                    // Filtrer par catégorie
                    if (categoryFilter && product.category !== categoryFilter) {
                        return false;
                    }
                    
                    // Filtrer par statut
                    if (statusFilter && product.status !== statusFilter) {
                        return false;
                    }
                    
                    // Filtrer par stock
                    if (stockFilter === 'low' && product.stock >= 5) {
                        return false;
                    }
                    if (stockFilter === 'out' && product.stock > 0) {
                        return false;
                    }
                    if (stockFilter === 'good' && product.stock < 5) {
                        return false;
                    }
                    
                    return true;
                });
                
                // Mettre à jour le compteur
                const countElement = document.getElementById('productCount');
                if (countElement) {
                    countElement.textContent = filteredProducts.length;
                }
                
                // Calculer la pagination
                const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageProducts = filteredProducts.slice(startIndex, endIndex);
                
                // Afficher les produits
                const tbody = document.getElementById('productsTable');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (pageProducts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <i class="fas fa-box-open" style="font-size: 3rem; color: #ddd; margin-bottom: 15px;"></i>
                                <h4 style="color: #777;">Aucun produit trouvé</h4>
                                <p>Essayez de modifier vos filtres ou ajoutez un nouveau produit.</p>
                                <a href="add-product.html" class="btn btn-success" style="margin-top: 15px;">
                                    <i class="fas fa-plus"></i> Ajouter un produit
                                </a>
                            </td>
                        </tr>
                    `;
                } else {
                    pageProducts.forEach(product => {
                        const row = document.createElement('tr');
                        
                        // Récupérer l'ID correct (MongoDB utilise _id)
                        const productId = product._id || product.id;
                        const productImage = product.images && product.images.length > 0 
                            ? product.images[0].url 
                            : 'https://via.placeholder.com/60x60?text=No+Image';
                        
                        row.innerHTML = `
                            <td>
                                <img src="${productImage}" 
                                     alt="${product.name}" 
                                     class="product-image"
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
                            </td>
                            <td>
                                <strong>${product.name || 'Sans nom'}</strong>
                                <div style="font-size: 12px; color: #777; margin-top: 5px;">
                                    ${product.description ? product.description.substring(0, 50) + '...' : 'Aucune description'}
                                </div>
                            </td>
                            <td>
                                <span class="status" style="background-color: #e8f4fc; color: #3498db; padding: 3px 8px; border-radius: 4px;">
                                    ${product.category || 'Non catégorisé'}
                                </span>
                            </td>
                            <td><strong>${admin.formatPrice(product.price || 0)}</strong></td>
                            <td>
                                ${product.stock || 0}
                                ${product.stock < 5 ? '<i class="fas fa-exclamation-triangle" style="color: #e74c3c; margin-left: 5px;"></i>' : ''}
                            </td>
                            <td><span class="status ${product.status || 'inactive'}">${product.status === 'active' ? 'Actif' : 'Inactif'}</span></td>
                            <td>${product.createdAt ? admin.formatDate(product.createdAt) : 'N/A'}</td>
                            <td class="actions">
                                <a href="edit-product.html?id=${productId}" class="btn btn-small" title="Modifier" data-tooltip="Modifier">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-small delete-btn" 
                                   data-item-name="${product.name}" 
                                   onclick="deleteProduct('${productId}')" 
                                   title="Supprimer"
                                   data-tooltip="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-small" title="Voir détails" data-tooltip="Voir détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
                
                // Afficher la pagination
                displayPagination(totalPages);
                
            } catch (error) {
                console.error('❌ Error displaying products:', error);
                const tbody = document.getElementById('productsTable');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #e74c3c;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                                <h4>Erreur de chargement</h4>
                                <p>${error.message}</p>
                                <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 15px;">
                                    <i class="fas fa-redo"></i> Réessayer
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Afficher la pagination
        function displayPagination(totalPages) {
            const paginationDiv = document.getElementById('pagination');
            if (!paginationDiv) return;
            
            paginationDiv.innerHTML = '';
            
            if (totalPages > 1) {
                // Bouton précédent
                const prevBtn = document.createElement('button');
                prevBtn.className = 'btn btn-small';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevBtn.disabled = currentPage === 1;
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayProducts();
                    }
                });
                paginationDiv.appendChild(prevBtn);
                
                // Pages
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-small ${i === currentPage ? 'btn-primary' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.style.margin = '0 5px';
                    pageBtn.addEventListener('click', () => {
                        currentPage = i;
                        displayProducts();
                    });
                    paginationDiv.appendChild(pageBtn);
                }
                
                // Bouton suivant
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn btn-small';
                nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayProducts();
                    }
                });
                paginationDiv.appendChild(nextBtn);
            }
        }

        // Appliquer les filtres
        const applyFiltersBtn = document.getElementById('applyFilters');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', function() {
                currentPage = 1;
                displayProducts();
            });
        }

        // Réinitialiser les filtres
        const resetFiltersBtn = document.getElementById('resetFilters');
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', function() {
                const categoryFilter = document.getElementById('categoryFilter');
                const statusFilter = document.getElementById('statusFilter');
                const stockFilter = document.getElementById('stockFilter');
                
                if (categoryFilter) categoryFilter.value = '';
                if (statusFilter) statusFilter.value = '';
                if (stockFilter) stockFilter.value = '';
                
                currentPage = 1;
                displayProducts();
            });
        }

        // Fonction pour supprimer un produit
        window.deleteProduct = async function(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce produit ? Cette action est irréversible.')) {
                try {
                    const deleted = await productManager.deleteProduct(id);
                    if (deleted) {
                        admin.showAlert('Produit supprimé avec succès!', 'success');
                        displayProducts(); // Rafraîchir la liste
                    }
                } catch (error) {
                    admin.showAlert(`Erreur lors de la suppression: ${error.message}`, 'error');
                }
            }
        };

        // Bouton d'export
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                const products = productManager.getAllProducts();
                
                // Vérifier que products est un tableau
                if (!Array.isArray(products)) {
                    admin.showAlert('Erreur: Les produits ne sont pas disponibles', 'error');
                    return;
                }
                
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "ID,Nom,Description,Catégorie,Prix,Stock,Statut\n"
                    + products.map(p => 
                        `${p._id || p.id},"${p.name || ''}","${p.description || ''}","${p.category || ''}",${p.price || 0},${p.stock || 0},${p.status || ''}`
                    ).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "produits_escompany.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                admin.showAlert('Export CSV téléchargé avec succès!', 'success');
            });
        }

        // Initialiser l'affichage
        displayProducts();
        
        // Rafraîchir les produits toutes les 30 secondes
        setInterval(() => {
            productManager.loadProducts().then(() => {
                displayProducts();
            });
        }, 30000);
    });
</script>
