<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifier un produit - Panel Admin E-S COMPANY</title>
    <link rel="icon" href="https://i.postimg.cc/44F5BnV2/file-000000001f3471fda269be0d033dc40a.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .image-preview {
            position: relative;
            width: 150px;
            height: 150px;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .image-preview i {
            font-size: 40px;
            color: #aaa;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .image-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        
        .image-upload-btn:hover {
            background-color: #e0e0e0;
        }
        
        #imageInput {
            display: none;
        }
        
        .form-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: var(--transition);
        }
        
        .tab-btn:hover {
            color: var(--primary-color);
        }
        
        .tab-btn.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .spec-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .spec-input input {
            flex: 1;
        }
        
        .remove-spec {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            width: 30px;
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="container admin-header-container">
            <div class="admin-logo">
                <img src="https://i.postimg.cc/44F5BnV2/file-000000001f3471fda269be0d033dc40a.png" alt="E-S COMPANY Logo" class="admin-logo-img">
                <div class="admin-logo-text">E-S <span>COMPANY</span> Admin</div>
            </div>
            
            <div class="admin-user">
                <span id="currentUserName"></span>
                <a href="#" class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </a>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Tableau de bord</a></li>
                <li><a href="products.html"><i class="fas fa-tshirt"></i> Produits</a></li>
                <li><a href="add-product.html"><i class="fas fa-plus-circle"></i> Ajouter un produit</a></li>
                <li><a href="#"><i class="fas fa-shopping-cart"></i> Commandes</a></li>
                <li><a href="#"><i class="fas fa-users"></i> Clients</a></li>
                <li><a href="#"><i class="fas fa-chart-bar"></i> Statistiques</a></li>
                <li><a href="#"><i class="fas fa-cog"></i> Paramètres</a></li>
            </ul>
        </aside>

        <!-- Main content -->
        <main class="main-content">
            <div class="page-header">
                <h1><i class="fas fa-edit"></i> Modifier le produit</h1>
                <a href="products.html" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i> Retour à la liste
                </a>
            </div>

            <!-- Alert message -->
            <div id="alertMessage" class="alert" style="display: none;"></div>

            <!-- Loading state -->
            <div id="loadingState" class="loading">
                <div class="loading-spinner"></div>
                <p>Chargement du produit...</p>
            </div>

            <!-- Formulaire d'édition (caché initialement) -->
            <div class="form-container" id="formContainer" style="display: none;">
                <form id="productForm">
                    <!-- Onglets -->
                    <div class="form-tabs">
                        <button type="button" class="tab-btn active" data-tab="basic">Informations de base</button>
                        <button type="button" class="tab-btn" data-tab="images">Images</button>
                        <button type="button" class="tab-btn" data-tab="specifications">Spécifications</button>
                    </div>

                    <!-- Onglet: Informations de base -->
                    <div class="tab-content active" id="basicTab">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            Tous les champs marqués d'un * sont obligatoires.
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="name">Nom du produit *</label>
                                <input type="text" id="name" name="name" class="form-control" placeholder="Ex: Robe d'été fleurie" required autocomplete="off">
                            </div>
                            
                            <div class="form-group">
                                <label for="category">Catégorie *</label>
                                <select id="category" name="category" class="form-control" required>
                                    <option value="">Sélectionnez une catégorie</option>
                                    <option value="robes">Robes</option>
                                    <option value="pantalons">Pantalons</option>
                                    <option value="jupes">Jupes</option>
                                    <option value="chaussures">Chaussures</option>
                                    <option value="bijoux">Bijoux</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="price">Prix (HTG) *</label>
                                <input type="number" id="price" name="price" class="form-control" placeholder="Ex: 2500" min="0" step="0.01" required autocomplete="off">
                            </div>
                            
                            <div class="form-group">
                                <label for="stock">Quantité en stock *</label>
                                <input type="number" id="stock" name="stock" class="form-control" placeholder="Ex: 15" min="0" required autocomplete="off">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="discount">Remise (%)</label>
                                <input type="number" id="discount" name="discount" class="form-control" placeholder="Ex: 10" min="0" max="100" step="1" autocomplete="off">
                            </div>
                            
                            <div class="form-group">
                                <label for="status">Statut *</label>
                                <select id="status" name="status" class="form-control" required>
                                    <option value="active">Actif (visible en boutique)</option>
                                    <option value="inactive">Inactif (caché en boutique)</option>
                                    <option value="out_of_stock">Rupture de stock</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="featured">En vedette</label>
                                <select id="featured" name="featured" class="form-control">
                                    <option value="false">Non</option>
                                    <option value="true">Oui</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description du produit *</label>
                            <textarea id="description" name="description" class="form-control" placeholder="Décrivez votre produit en détail..." rows="5" required autocomplete="off"></textarea>
                        </div>
                    </div>

                    <!-- Onglet: Images -->
                    <div class="tab-content" id="imagesTab">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            Vous pouvez modifier les images existantes ou en ajouter de nouvelles.
                        </div>
                        
                        <!-- Input pour upload d'images -->
                        <label class="image-upload-btn" for="imageInput">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Ajouter des images</span>
                        </label>
                        <input type="file" id="imageInput" accept="image/*" multiple>
                        
                        <!-- Prévisualisation des images -->
                        <div class="image-preview-container" id="imagePreviewContainer">
                            <!-- Les images seront ajoutées ici dynamiquement -->
                        </div>
                        
                        <div class="form-group">
                            <label>Images URL (alternative)</label>
                            <textarea id="imageUrls" class="form-control" placeholder="Vous pouvez aussi entrer des URLs d'images, une par ligne" rows="3" autocomplete="off"></textarea>
                            <small style="color: #777; font-size: 12px;">Entrez une URL par ligne. Ces images seront ajoutées aux images existantes.</small>
                        </div>
                    </div>

                    <!-- Onglet: Spécifications -->
                    <div class="tab-content" id="specificationsTab">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            Modifiez les spécifications techniques de votre produit.
                        </div>
                        
                        <div id="specificationsContainer">
                            <!-- Spécifications dynamiques -->
                        </div>
                        
                        <button type="button" class="btn btn-small" onclick="addSpecField()" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i> Ajouter une spécification
                        </button>
                    </div>

                    <!-- Boutons d'action -->
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;">
                        <button type="submit" class="btn btn-warning" style="padding: 12px 30px;">
                            <i class="fas fa-save"></i> Mettre à jour le produit
                        </button>
                        <button type="button" class="btn btn-outline" style="margin-left: 15px;" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Réinitialiser
                        </button>
                        <a href="products.html" class="btn" style="margin-left: 15px;">
                            <i class="fas fa-times"></i> Annuler
                        </a>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://es-company-api.onrender.com'; // Remplacez par votre URL Render
        let authToken = null;
        let productId = null;
        let originalProductData = null;
        let selectedImages = []; // Pour stocker les images (existantes + nouvelles)
        let existingImages = []; // Pour stocker les images existantes

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier l'authentification
            authToken = localStorage.getItem('admin_token');
            if (!authToken) {
                window.location.href = 'index.html';
                return;
            }
            
            // Afficher le nom d'utilisateur
            const user = JSON.parse(localStorage.getItem('admin_user') || '{}');
            if (user && user.name) {
                document.getElementById('currentUserName').textContent = user.name;
            }
            
            // Gestion de la déconnexion
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_user');
                window.location.href = 'index.html';
            });
            
            // Récupérer l'ID du produit depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            productId = urlParams.get('id');
            
            if (!productId) {
                showError('Aucun produit sélectionné');
                setTimeout(() => {
                    window.location.href = 'products.html';
                }, 2000);
                return;
            }
            
            // Charger le produit
            loadProduct();
        });

        // Charger le produit depuis l'API
        async function loadProduct() {
            try {
                const response = await fetch(`${API_URL}/api/products/${productId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    // Token invalide ou expiré
                    localStorage.removeItem('admin_token');
                    localStorage.removeItem('admin_user');
                    window.location.href = 'index.html';
                    return;
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    originalProductData = data.data.product;
                    displayProduct(originalProductData);
                } else {
                    throw new Error(data.message || 'Erreur de chargement');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showError('Erreur de chargement: ' + error.message);
                setTimeout(() => {
                    window.location.href = 'products.html';
                }, 3000);
            }
        }

        // Afficher le produit dans le formulaire
        function displayProduct(product) {
            // Remplir les champs de base
            document.getElementById('name').value = product.name || '';
            document.getElementById('description').value = product.description || '';
            document.getElementById('price').value = product.price || '';
            document.getElementById('stock').value = product.stock || '';
            document.getElementById('discount').value = product.discount || 0;
            document.getElementById('status').value = product.status || 'active';
            document.getElementById('featured').value = product.featured ? 'true' : 'false';
            document.getElementById('category').value = product.category || '';
            
            // Gérer les images
            existingImages = product.images || [];
            selectedImages = [...existingImages]; // Copier les images existantes
            updateImagePreviews();
            
            // Gérer les spécifications
            displaySpecifications(product.specifications || {});
            
            // Initialiser les onglets
            initTabs();
            
            // Initialiser l'upload d'images
            initImageUpload();
            
            // Initialiser le formulaire
            initForm();
            
            // Cacher le loading et afficher le formulaire
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('formContainer').style.display = 'block';
        }

        // Afficher les spécifications
        function displaySpecifications(specs) {
            const container = document.getElementById('specificationsContainer');
            container.innerHTML = '';
            
            // Ajouter un champ vide par défaut
            if (Object.keys(specs).length === 0) {
                addSpecField();
                return;
            }
            
            // Ajouter les spécifications existantes
            Object.entries(specs).forEach(([key, value]) => {
                const div = document.createElement('div');
                div.className = 'spec-input';
                div.innerHTML = `
                    <input type="text" class="form-control spec-key" placeholder="Clé" value="${key}" autocomplete="off">
                    <input type="text" class="form-control spec-value" placeholder="Valeur" value="${value}" autocomplete="off">
                    <button type="button" class="remove-spec" onclick="removeSpecField(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // Initialiser les onglets
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Désactiver tous les onglets
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Activer l'onglet courant
                    this.classList.add('active');
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });
        }

        // Initialiser l'upload d'images
        function initImageUpload() {
            const imageInput = document.getElementById('imageInput');
            const imageUrlsTextarea = document.getElementById('imageUrls');
            
            // Gérer la sélection de fichiers
            imageInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                
                // Limiter à 5 fichiers au total
                if (files.length + selectedImages.length > 5) {
                    showError('Vous ne pouvez avoir que 5 images maximum');
                    return;
                }
                
                files.forEach(file => {
                    // Vérifier le type de fichier
                    if (!file.type.match('image.*')) {
                        showError(`Le fichier ${file.name} n'est pas une image`);
                        return;
                    }
                    
                    // Vérifier la taille (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showError(`L'image ${file.name} est trop volumineuse (max 5MB)`);
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imageData = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            dataUrl: e.target.result,
                            isFile: true,
                            isNew: true
                        };
                        
                        selectedImages.push(imageData);
                        updateImagePreviews();
                    };
                    
                    reader.readAsDataURL(file);
                });
                
                // Réinitialiser l'input
                imageInput.value = '';
            });
            
            // Gérer les URLs d'images
            imageUrlsTextarea.addEventListener('blur', function() {
                const urls = this.value.split('\n')
                    .map(url => url.trim())
                    .filter(url => url && url.startsWith('http'));
                
                // Ajouter les URLs comme nouvelles images
                urls.forEach(url => {
                    if (!selectedImages.some(img => img.url === url || img.dataUrl === url)) {
                        selectedImages.push({
                            id: Date.now() + Math.random(),
                            name: 'URL Image',
                            dataUrl: url,
                            isFile: false,
                            isNew: true
                        });
                    }
                });
                
                updateImagePreviews();
                this.value = ''; // Vider le textarea
            });
        }

        // Mettre à jour les prévisualisations d'images
        function updateImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            
            // Effacer le contenu
            container.innerHTML = '';
            
            if (selectedImages.length === 0) {
                container.innerHTML = `
                    <div class="image-preview">
                        <i class="fas fa-image"></i>
                        <p style="text-align: center; font-size: 12px; color: #777; margin-top: 5px;">Aucune image</p>
                    </div>
                `;
                return;
            }
            
            // Afficher chaque image
            selectedImages.forEach((image, index) => {
                const div = document.createElement('div');
                div.className = 'image-preview';
                
                // Déterminer si c'est une nouvelle image ou existante
                const isExisting = !image.isNew;
                const imageUrl = image.dataUrl || image.url;
                
                div.innerHTML = `
                    <img src="${imageUrl}" alt="${image.name || 'Product image'}">
                    <div class="remove-image" onclick="removeImage(${index})">
                        <i class="fas fa-times"></i>
                    </div>
                    ${isExisting ? '<div style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 5px; border-radius: 3px; font-size: 10px;">Existante</div>' : ''}
                `;
                
                container.appendChild(div);
            });
        }

        // Supprimer une image
        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagePreviews();
        }

        // Ajouter un champ de spécification
        function addSpecField() {
            const container = document.getElementById('specificationsContainer');
            
            const div = document.createElement('div');
            div.className = 'spec-input';
            div.innerHTML = `
                <input type="text" class="form-control spec-key" placeholder="Clé (ex: Matériel)" autocomplete="off">
                <input type="text" class="form-control spec-value" placeholder="Valeur (ex: Coton)" autocomplete="off">
                <button type="button" class="remove-spec" onclick="removeSpecField(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(div);
        }

        // Supprimer un champ de spécification
        function removeSpecField(button) {
            const container = document.getElementById('specificationsContainer');
            const inputs = container.querySelectorAll('.spec-input');
            
            // Ne pas supprimer s'il ne reste qu'un champ
            if (inputs.length > 1) {
                button.parentElement.remove();
            }
        }

        // Initialiser le formulaire
        function initForm() {
            const form = document.getElementById('productForm');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Désactiver le bouton de soumission
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mise à jour...';
                submitBtn.disabled = true;
                
                try {
                    // Valider le formulaire
                    if (!validateForm()) {
                        throw new Error('Veuillez remplir tous les champs obligatoires');
                    }
                    
                    // Préparer les données
                    const formData = new FormData(form);
                    const productData = {
                        name: formData.get('name'),
                        description: formData.get('description'),
                        price: parseFloat(formData.get('price')),
                        category: formData.get('category'),
                        stock: parseInt(formData.get('stock')),
                        status: formData.get('status'),
                        featured: formData.get('featured'),
                        discount: parseInt(formData.get('discount') || 0)
                    };
                    
                    // Ajouter les images (seulement les nouvelles)
                    const newImages = selectedImages.filter(img => img.isNew);
                    if (newImages.length > 0) {
                        const images = newImages.map(img => ({
                            url: img.dataUrl,
                            alt: productData.name
                        }));
                        productData.images = JSON.stringify(images);
                    }
                    
                    // Ajouter les spécifications
                    const specifications = {};
                    const specKeys = document.querySelectorAll('.spec-key');
                    const specValues = document.querySelectorAll('.spec-value');
                    
                    for (let i = 0; i < specKeys.length; i++) {
                        const key = specKeys[i].value.trim();
                        const value = specValues[i].value.trim();
                        
                        if (key && value) {
                            specifications[key] = value;
                        }
                    }
                    
                    productData.specifications = JSON.stringify(specifications);
                    
                    console.log('Mise à jour des données:', productData);
                    
                    // Envoyer la requête de mise à jour
                    const response = await fetch(`${API_URL}/api/products/${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(productData)
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        showSuccess('Produit mis à jour avec succès!');
                        
                        // Rediriger après 2 secondes
                        setTimeout(() => {
                            window.location.href = 'products.html';
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'Erreur lors de la mise à jour');
                    }
                } catch (error) {
                    console.error('Error updating product:', error);
                    showError('Erreur: ' + error.message);
                } finally {
                    // Réactiver le bouton
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
        }

        // Réinitialiser le formulaire aux valeurs originales
        function resetForm() {
            if (originalProductData) {
                displayProduct(originalProductData);
                showSuccess('Formulaire réinitialisé aux valeurs originales');
            }
        }

        // Valider le formulaire
        function validateForm() {
            const requiredFields = ['name', 'description', 'price', 'category', 'stock'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    return false;
                }
            }
            
            return true;
        }

        // Afficher un message de succès
        function showSuccess(message) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = 'alert alert-success';
            alertDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            alertDiv.style.display = 'flex';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // Afficher un message d'erreur
        function showError(message) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = 'alert alert-error';
            alertDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            alertDiv.style.display = 'flex';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
